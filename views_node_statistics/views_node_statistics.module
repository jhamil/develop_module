<?php

/**
 * Implements hook_menu().
 */
function views_node_statistics_menu() {
  $items = array();
  $items['admin/structure/views/node-statistics'] = array(
    'title' => 'Node statistics',
    'description' => 'Configuration for the node statistics.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('views_node_statistics_form'),
    'access arguments' => array('administer views'),
    'weight' => 50,
    'type' => MENU_LOCAL_TASK
  );

  return $items;
}

/**
 * Build form for statistics form
 * Create and display the Views node statistics configuration settings form.
 */
function views_node_statistics_form($form, &$form_state) {
  $views = views_get_all_views();
  $options = array();

  foreach ($views as $key => $value) {
    if (is_null($value->disabled)) {
      $options[$key] = $value->human_name;
    }
  }

  $form['views_node_statistics'] = array(
      '#type' => 'checkboxes',
      '#default_value' => variable_get('views_node_statistics', array()),
      '#options' => $options,
      '#description' => 'Select the views that you want to track'
  );

  return system_settings_form($form);
}

/**
 * Implements hook_views_pre_render().
 */
function views_node_statistics_views_pre_render(&$view) {
  $query = $view->build_info['query'];
  if (is_numeric($view->total_rows)) {
    $query->range(0, $view->total_rows);
  }
  $result = $query->execute();
  $nids = array();
  foreach ($result as $row) {
    $nids[] = $row->nid;
  }

  views_node_statistics_count_results($nids);
}

function views_node_statistics_count_results($nids) {
  $results = variable_get('results', array());

  foreach ($nids as $nid) {
    if (!isset($results[$nid])) {
      $results[$nid] = 0;
    }
    $results[$nid] = $results[$nid] + 1;
  }

  dsm($results);

  variable_set('results', $results);

  views_node_statistics_update_entity($results, 'nombre_vista');
}

function views_node_statistics_update_entity($results, $view_name) {
  $result = new StdClass();
  $result->type = 'report';

  entity_save('report', $result);
}
